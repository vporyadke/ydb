# Настройка Hive

Поведение [Hive](../../concepts.md#hive) можно настроить с помощью следующих опций в секции `hive_config`.

#|
|| Параметр | Формат | Описание ||
|| max_tablets_scheduled | Целое число | Максимальное число таблеток, одновременно находящихся в процессе старта на одном узле. ||
|| max_boot_batch_size | Целое число | Максимальное число таблеток из очереди на запуск, обрабатываемых за раз. ||
|| drain_inflight | Целое число | Число таблеток, одновременно перезапускающихся в процессе плавного перемещения всех таблеток с одного узла (drain). ||
|| min_scatter_to_balance | Вещественное число | Порог метрики Scatter для ресурсов CPU, Memory, Network. Имеет приоритет ниже, чем параметры ниже. ||
|| min_cpuscatter_to_balance | Вещественное число | Порог метрики Scatter для ресурса CPU. ||
|| min_memory_scatter_to_balance | Вещественное число | Порог метрики Scatter для ресурса Memory. ||
|| min_network_scatter_to_balance | Вещественное число | Порог метрики Scatter для ресурса Network. ||
|| min_counter_scatter_to_balance | Вещественное число | Порог метрики Scatter для ресурса Counter. ||
|| min_node_usage_to_balance | Вещественное число | Потребление ресурсов на узле ниже данного значения приравнивается к данному значению. ||
|| max_node_usage_to_kick | Вещественное число | Порог потребления ресурсов на узле для запуска emergency-автобалансировки. ||
|| node_usage_range_to_kick | Вещественное число | Автобалансировка считается нецелесообразной, если разница в уровне потребления ресурсов между узлами меньше этого значения. ||
|| resource_change_reaction_period | Целое число секунд | Частота обновления агрегированной статистики потребления ресурсов. ||
|| tablet_kick_cooldown_period | Целое число секунд | Минимальный период времени между перемещениями одной таблетки. ||
|| node_select_strategy | Перечисление | Стратегия выбора узла для запуска таблетки. Возможные варианты:

- `HIVE_NODE_SELECT_STRATEGY_WEIGHTED_RANDOM` — взвешенно-случайный выбор на основе потребления; 
- `HIVE_NODE_SELECT_STRATEGY_EXACT_MIN` — выбор узла с минимальным потреблением;
- `HIVE_NODE_SELECT_STRATEGY_RANDOM_MIN_7P` — выбор случайного узла среди 7% узлов с наименьшим потреблением;
- `HIVE_NODE_SELECT_STRATEGY_RANDOM` — выбор случайного узла.

||
|| spread_neighbours | true/false | Запуск таблеток одного объекта по возможности на разных узлах. ||
|| max_resource_cpu | Целое число наносекунд | Максимальное потребление CPU на узле в секунду. Значение по умолчанию, используется только если узел не предоставляет значение при регистрации в Hive. ||
|| max_resource_memory | Целое число байт | Максимальное потребление памяти на узле. Значение по умолчанию, используется только если узел не предоставляет значение при регистрации в Hive. ||
|| max_resource_network | Целое число байт/секунду | Максимальное потребление полосы на узле. Значение по умолчанию, используется только если узел не предоставляет значение при регистрации в Hive. ||
|| max_resource_counter | Целое число наносекунд | Максимальное потребление виртуального ресурса Counter на узле. ||
|| request_sequence_size | Целое число | Количество идентификаторов таблеток, которое за один раз Hive базы данных запрашивает у корневого Hive. ||
|| min_request_sequence_size | Целое число | Минимальное количество идентификаторов таблеток, которое за один раз корневой Hive выделяет для Hive базы данных. ||
|| max_request_sequence_size | Целое число | Максимальное количество идентификаторов таблеток, которое за один раз выделяет для Hive базы данных. ||
|| default_unit_iops | Целое число | Значение по умолчанию для IOPS одного канала. ||
|| default_unit_throughput | Целое число байт/секунду | Значение по умолчанию для потребления пропускной способности одним каналом. ||
|| default_unit_size | Целое число байт | Значение по умолчанию для потребления места на дисках одним каналом. ||
|| storage_overcommit | Вещественное число | Коэффициент переподписки на ресурсы групп хранения. ||
|| storage_balance_strategy | Перечисление | Выбор параметра используемого для распределения каналов таблеток по группам хранения. Вариант AUTO — использование того, чьё потребление максимально.Возможные варианты: `HIVE_STORAGE_BALANCE_STRATEGY_AUTO`, `HIVE_STORAGE_BALANCE_STRATEGY_IOPS`, `HIVE_STORAGE_BALANCE_STRATEGY_IOPS`, `HIVE_STORAGE_BALANCE_STRATEGY_SIZE`. ||
|| storage_safe_mode | true/false | Проверка превышения максимального потребления ресурсов групп хранения. ||
|| storage_select_strategy | Выбор из списка | Стратегия выбора группы хранения для канала таблетки. Возможные варианты:

- `HIVE_STORAGE_SELECT_STRATEGY_WEIGHTED_RANDOM` — взвешенно-случайный выбор на основе потребления;
- `HIVE_STORAGE_SELECT_STRATEGY_EXACT_MIN` — выбор группы с минимальным потреблением;
- `HIVE_STORAGE_SELECT_STRATEGY_RANDOM_MIN_7P` — выбор случайной группы среди 7% групп с наименьшим потреблением;
- `HIVE_STORAGE_SELECT_STRATEGY_RANDOM` — выбор случайной группы;
- `HIVE_STORAGE_SELECT_STRATEGY_ROUND_ROBIN` - выбор группы внтури пула хранения по принципу [Round-robin](https://ru.wikipedia.org/wiki/Round-robin_(%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC)).
||
|| min_period_between_reassign | Целое число секунд | Минимальный период времени между переназначениями групп хранения для каналов одной таблетки. ||
|| metrics_window_size | Целое число миллисекунд | Размер окна, на котором агрегируются метрики потребления ресурсов таблетками. ||
|| resource_overcommitment | Вещественное число | Коэффициент переподписки на ресурсы узлов. ||
|| node_balance_strategy | Перечисление | Стратегия выбора узла, с которого перевозятся таблетки при автобалансировке. Возможные варианты:

- `HIVE_NODE_BALANCE_STRATEGY_WEIGHTED_RANDOM` — взвешенно-случайный выбор на основе потребления;
- `HIVE_NODE_BALANCE_STRATEGY_HEAVIEST` — выбор узла с максимальным потреблением;
- `HIVE_NODE_BALANCE_STRATEGY_RANDOM` — выбор случайного узла.

||
|| tablet_balance_strategy | Перечисление | Стратегия выбора таблетки для перевоза при автобалансировке. Возможные варианты:

- `HIVE_TABLET_BALANCE_STRATEGY_WEIGHTED_RANDOM` — взвешенно-случайный выбор на основе потребления;
- `HIVE_TABLET_BALANCE_STRATEGY_HEAVIEST` — выбор таблетки с максимальным потреблением;
- `HIVE_TABLET_BALANCE_STRATEGY_RANDOM` — выбор случайной таблетки.

||
|| min_period_between_balance | Вещественное число секунд | Минимальный период времени между двумя итерациями автобалансировки, не относится к emergency-балансировке. ||
|| balancer_inflight | Целое число | Число таблеток, одновременно перезапускающихся в процессе автобалансировки, не относится к emergency-балансировке. ||
|| max_movements_on_auto_balancer | Целое число | Число перемещений таблеток за одну итерацию автобалансировки, не относится к emergency-балансировке. ||
|| continue_auto_balancer | вкл/выкл | При включении следующая итерация балансировки запускается, не дожидаясь окончания ResourceChangeReactionPeriod. ||
|| min_period_between_emergency_balance | Вещественное число секунд | Аналогично MinPeriodBetweenBalance, но для emergency-балансировки. ||
|| emergency_balancer_inflight | Целое число | Аналогично BalancerInflight, но для emergency-балансировки. ||
|| max_movements_on_emergency_balancer | Целое число | Аналогично MaxMovementsOnAutoBalancer, но для emergency-балансировки. ||
|| continue_emergency_balancer | true/false | Аналогично ContinueAutoBalancer, но для emergency-балансировки. ||
|| check_move_expediency | вкл/выкл | Проверка целесообразности перемещений таблеток. ||
|| tablet_restart_watch_period | Целое число секунд | Размер окна, на котором собирается статистика о числе рестартов таблетки. ||
|| node_restart_watch_period | Целое число секунд | Размер окна, на котором собирается статистика о числе рестартов узла. ||
|| node_delete_period | Целое число секунд | Период неактивности, по истечении которого, узел удаляется из базы Hive. ||
|| default_tablet_limit | Вложенная секция | Ограничения на запуск таблеток различных типов на одном узле. Указывается в формате списка, где каждый элемент имеет поля type и max_count.
|| default_tablet_preference | Вложенная секция | Приоритеты по выбору датацентров для запуска таблеток различных типов. Для каждого типа таблетки можно указать несколько групп датацентров. Датацентры внутри одной группы будут иметь одинаковый приоритет, а более ранняя группа будет иметь приориет над последующими. Пример формата:

```yaml
default_tablet_preference:
  - type: Coordinator
    data_centers_preference:
      - data_centers_group:
        - "sas"
        - "vla"
      - data_centers_group:
        - "klg"
```

|| system_category_id | Целое число | При указании любого отличного от 0 числа, все координаторы и медиаторы по возможности запускаются в одном и том же датацентре.
|| enable_fast_tablet_move | true/false | Данная опция позволяет не дожидаться смерти предыдущего поколения таблетки при запуске нового. ||
|| tablet_restarts_period | Целое число миллисекунд | Окно, на котором считается количество рестартов таблетки, для пессимизации запуска проблемных таблеток. ||
|| tablet_restarts_max_count | Целое число | Количество рестартов на окне выше, при превышении которого, применяется пессимизация. ||
|| postopone_start_period | Целое число миллисекунд | Попытки запускать проблемные таблетки делаются не чаще чем раз в это количество миллисекунд. ||
|| storage_pool_fresh_period | Целое число миллисекунд | Информация о пулах хранения столько времени считается актуальной. ||
|| pools_to_monitor_for_usage | Названия пулов через запятую | Пулы актор-системы, потребление в которых учитывается при подсчётё потребления ресурсов узла. ||
|| space_usage_penalty_threshold | Вещественное число | При перевозе канала из-за кончающегося места в группе пессимизировать группы, в которых свободное место отличается во столько или менее раз от исходной группы. ||
|| space_usage_penalty | Вещественное число | Коэффициент штрафа, описанного выше. ||
|| warm_up_boot_waiting_Period | Целое число миллисекунд | Время ожидания старта всех известных узлов при старте базы. ||
|| max_warm_up_period | Целое число секунд | Максимальное время ожидания старта узлов при старте базы. ||
|| warm_up_enabled | true/false | Ожидание старта всех узлов при старте базы или запуск таблеток на первом подключившемся. ||
|| object_imbalance_to_balance | Вещественное число | Порог метрики дисбаланса таблеток одного объекта. ||
|| boot_strategy | Перечисление | Регулирует поведение при запуске большого числа таблеток. Возможные варианты:

* `HIVE_BOOT_STRATEGY_BALANCED` — при достижении лимита в `max_tablets_scheduled` на одном узле останавливает запуск новых таблеток на всех узлах.
* `HIVE_BOOT_STRATEGY_FAST` — при достижении лимита в `max_tablets_scheduled` на одном узле продолжает запуск таблеток на других узлах.

||
|| channel_balance_strategy | Перечисление | Стратегия выбора канала для переназначения при балансировке каналов. Возможные варианты:

- `HIVE_CHANNEL_BALANCE_STRATEGY_WEIGHTED_RANDOM` — взвешенно-случайный выбор на основе потребления;
- `HIVE_CHANNEL_BALANCE_STRATEGY_HEAVIEST` — выбор канала с максимальным потреблением;
- `HIVE_CHANNEL_BALANCE_STRATEGY_RANDOM` — выбор случайного канала.

||
|| max_channel_history_size | Целое число | Балансировка каналов не должна приводить к тому, чтобы размер истории канала превышал это значение. ||
|| storage_info_refresh_frequency | Целое число миллисекунд | Частота обновления информации о пулах хранения. ||
|| min_storage_scatter_to_balance | Вещественное число | Порог метрики Scatter для групп хранения. ||
|| min_group_usage_to_balance | Вещественное число | Потребление ресурсов группы хранения ниже данного значения приравнивается к данному значению. ||
|| storage_balancer_nflight | Целое число | Число таблеток, одновременно перезапускающихся во время балансировки каналов. ||
|| enable_destroy_operations | true/false | Разрешены ли деструктивные ручные операции. ||
|| less_system_tablets_moves | true/false | Минимизация перемещения системных таблеток при автобалансировке. ||
|| balancer_ignore_tablet_types | Список типов таблеток, разделённый точкой с запятой | Типы таблеток, на которые не распространяется автобалансировка. ||
|| max_pings_in_flight | Целое число | Максимальное количество параллельно устаналиваемых соединений с узлами. ||
|| cut_history_deny_list | Список типов таблеток, разделённый запятой | Список типов таблеток, для которых игнорируется операция очистки истории. ||
|| cut_history_allow_list | Список типов таблеток, разделённый запятой | Список типов таблеток, для которых разрешена операция очистки истории. ||
|| scale_recommendation_refresh_frequency | Целое число миллисекунд | Как часто обновляется рекоммендация по количеству вычислительных узлов. ||
|| scale_out_window_size | Целое число | Количество бакетов, на основе которых принимается решение о рекоммендации увеличить число вычислительных узлов. ||
|| scale_in_window_size | Целое число | Количество бакетов, на основе которых принимается решение о рекоммендации уменьшить число вычислительных узлов. ||
|| target_tracking_cpumargin | Вещественное число | Допустимое отклонение от целевого значения утилизации CPU при автоскейлинге ||
|| dry_run_target_tracking_cpu | Вещественное число | Целевое значение утилизации CPU для проверки, как работал бы автоскейлинг. ||
|| node_restarts_for_penalty | Целое число | Узлы получают понижение приоритета за такое количество рестартов на окне в `node_restart_watch_period`. ||
|#
