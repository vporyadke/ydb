# Управление группами хранения в Hive

В данной статье описывается процесс выдачи [таблеткам](../concepts/glossary.md#tablet) [групп хранения](../concepts/glossary.md#storage-group) со стороны [Hive](../concepts/glossary.md#hive). При создании таблетки Hive назначает ей группы и в дальнейшем может их изменить:

* Если в группе заканчивается место, таблетки получают об этом сигнал от [прокси](../concepts/glossary.md#ds-proxy) и передают в Hive запрос выдать им другую группу.
* При [ручном перераспределении групп](../reference/embedded-ui/hive.md#reassign-groups).
* При автоматическом перераспределении групп (отключёно по умолчанию в [конфигурации Hive](../reference/configuration/hive.md#storage)).

## Выбор группы {#pick-group}

Для каждого из [каналов](../concepts/glossary.md#tablet-channel) таблетки группа выбирается независимо. Вполне возможно, что разные каналы одной и той же таблетки пишут в одну и ту же группу. За каждым каналом закреплён [пул хранения](../concepts/glossary.md#storage-pool) и для этого канала могут быть выбраны только группы из этого пула. Пулы хранения не пересекаются между разными базами данных на одном кластере, при этом у одной базы может быть больше одного пула.

Выбор группы внутри пула делается на основе метрик потребления, принцип работы которых описан в [следующем разделе](#allocation-units). С их помощью для каждой группы-кандидата $i$ определяется значение потребления $0 < \mathrm{usage}_i < 1$. Затем группа выбирается при помощи взвешенной случайности с весами $w_i = \max_j (\mathrm{usage}_j) - \mathrm{usage}_i$.

В случае кончающегося места важно избежать ситуации, при которой таблетки будут постоянно перемещаться между разными группами, в которых не хватает свободного места. Для того, чтобы избежать этого, в этой версии веса дополнительно модифицируются, чтобы пессимизировать группы, где тоже кончается место. А именно если таблетка перевозится с группы $j$, в которой кончается место, то для группы $i$ модифицированный вес вычисляется по формуле:

$$
\hat{w_i} =
\begin{cases}
  0, & \mathrm{free}_i < \mathrm{free}_j \\
  \alpha \cdot w_i, & \mathrm{free}_j \le \mathrm{free_i} < \beta \cdot \mathrm{free}_j \\
  w_i, & \mathrm{free}_i \ge \beta \cdot \mathrm{free}_j
\end{cases}
$$

где $free_g$ — реальное свободное место в группе $g$, $\alpha, \beta$ — константы. По умолчанию $\alpha = 0.2, \beta = 1.1$, эти значения можно настроить как `space_usage_penalty` и `space_usage_penalty_threshold` в [конфигурации Hive](../reference/configuration/hive.md#storage).

## Единицы аллокации {#allocation-units}

Как и для [выбора узла](hive-booting.md#findbestnode) для запуска таблеток, для выбора групп в Hive предусмотрен учёт потребления таблетками ресурсов. Однако, смена группы — более редкая операция, поэтому вместо мгновенных значений потребления используется механизм [единиц аллокации](../concepts/glossary.md#allocation-units) (allocation units): при создании таблетки [SchemeShard](../concepts/glossary.md#scheme-shard) выставляет для каждого из каналов ожидаемое потребление ресурсов этим каналом, и Hive в дальнейшем использует эти значения. Единицами аллокации для различных таблеток можно управлять при помощи секции `channel_profile_config` в конфигурации кластера. Используются три метрики: IOPS, потребление пропускной способности, и потребление дискового пространства. В конфигурации Hive можно настроить учёт какой-либо одной из них или сразу всех.


## Процесс переназначения групп {#reassign}

Для безопасной смены группы Hive сначала осуществляет блокировку записи в текущем [поколении](../concepts/glossary.md#tablet-generation) в системном канале таблетки, и только после этого запускает новое поколение таблетки с новой записью в [истории](general-schema.md#history).
