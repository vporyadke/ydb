# Запуск таблеток

В данной статье описывается процесс запуска [таблеток](../concepts/glossary.md#tablet) со стороны [Hive](../concepts/glossary.md#hive).

## Очередь {#bootqueue}

Hive принимает решение о запуске таблетки в различных ситуациях:

* Таблетка только что была создана.
* Утрачена связь с узлом, на котором была запущена таблетка.
* Узел, на котором была запущена таблетка, прислал сообщение о том, что она прекратила работу (например, из-за потери связи с дисковой подсистемой кластера).
* При перевозе таблетки в рамках [автобалансировки](hive.md#autobalancing).

В любой из этих ситуаций таблетка кладётся в очередь на запуск, или *Boot queue*. Очередь хранится в памяти Hive и является приоритетной. Приоритет таблетки определяется следующими факторами:

1. Тип таблетки — системные таблетки имеют более высокий приоритет, чем пользовательские.
1. [Метрики потребления ресурсов](hive.md#resources): таблетки с бóльшим потреблением имеют бóльший приоритет.
1. Таблетки, которые часто перезапускаются, имеют пониженный приоритет.

При обработке очереди за раз обрабатывается ограниченное количество таблеток (`max_boot_batch_size` в [конфигурации](../reference/configuration/hive.md#boot)). Это нужно для того, чтобы при запуске большого числа таблеток Hive не переставал на долгое время отвечать на другие запросы.

Если при обработке очередной таблетки оказывается, что её нельзя запустить ни на одном из узлов, то эта таблетка откладывается в отдельную очередь *Wait queue*. Когда доступность узла меняется (подключается новый узел, или с узла снимается ограничение в [Hive UI](../reference/embedded-ui/hive.md)), Hive возвращается к этим таблеткам и при обработке очереди на запуск чередует таблетки из Boot Queue и таблетки из Wait Queue.

```mermaid
---
config:
  layout: elk
---
stateDiagram
  [*] --> BQ:Нужно запустить таблетку
  BQ --> PBQ
  PBQ --> Running
  PBQ --> WQ:При отсутствии подходящего узла
  WQ --> PBQ:При появлении доступного узла
  BQ:Boot queue
  WQ:Wait queue
  PBQ:Обработка очереди
  Running:Запуск таблетки
```

{% note warning %}

Одновременный запуск множества таблеток может создавать повышенную нагрузку на узел. Поэтому максимальное число одновременно запускаемых таблеток на одном узле ограничено значением `max_tablets_scheduled` из конфигурации. При этом, если один из узлов упирается в это ограничение, Hive останавливает запуск новых таблеток и на других узлах тоже, чтобы это не повлияло на равномерность распределения. Это поведение можно регулировать с помощью параметра `boot_strategy`.

{% endnote %}

## Выбор узла {#findbestnode}

В этом разделе описан алгоритм выбора узла для запуска таблетки. Он включает в себя учёт ограничений на запуск, приоритетов датацентров, метрик потребления ресурсов таблеткой и узлами.

Существуют строгие ограничения на то, на каких узлах разрешено запускать таблетку: не каждый узел может запускать каждый тип таблеток; таблетки некоторой базы данных могут быть запущены только на узлах этой базы данных. Дополнительно при **перевозе** таблеток не рассматриваются перегруженные узлы.

Из всех подходящих узлов отбираются узлы с максимальным приоритетом. Приоритет определяется исходя из датацентра, в котором находится узел. Явно указать приоритеты датацентров можно в подсекции `default_tablet_preference` в конфигурации. Для [координаторов](../concepts/glossary.md#coordinator) и [медиаторов](../concepts/glossary.md#mediator) приоритеты определяются динамически так, чтобы по возможности поддерживать их в одном датацентре. Дополнительно, если таблетка завершает работу с ошибкой на некотором узле, на следующий запуск этой таблетки приоритет этого узла понижается.

Для узлов с максимальным приоритетом считается целевая метрика, которая почти совпадает с метрикой [Node usage](hive.md#node-usage). Она отличается тем, что учитываются только те ресурсы, которые потребляет данная таблетка, а также наличием штрафа за количество таблеток того же [объекта схемы](../concepts/glossary.md#schema-object).

Наконец, на основе этой метрики делается выбор узла. Алгоритм выбора на этом этапе определяется параметром `node_select_strategy` в конфигурации. По умолчанию выбирается случайный узел из 7% узлов с минимальным значением метрики.

Ниже приведена иллюстрация процесса.

```mermaid
block-beta
    columns 6
    Node11("Node 1\nallowed") Node12("Node 2\nallowed") Node13("Node 3\nmarked down") Node14("Node 4\nallowed") Node15("Node 5\noverloaded") Node16("Node 6\nallowed")
    Arrow1<["\n"]>(down):6
    Node21("Node 1\nPriority:0") Node22("Node 2\nPriority: 1") space Node24("Node 4\nPriority: 1") space Node26("Node 6\nPriority: 0")
    Arrow2<["\n"]>(down):6
    space Node32("Node 2\nUsage: 60%") space Node34("Node 4\nUsage: 30%") space:2
    Arrow3<["\n"]>(down):6
    Pick["Pick Node 4"]:6
```

## Ограничения одновременного запуска {#limit}

## Процесс запуска {#booting}

На каждом узле запущен сервис [Local](../concepts/glossary.md#local), отвечающий за взаимодействие с Hive. При запуске таблетки Hive отправляет в Local нужного узла команду старта таблетки, содержащую всю необходмиую для запуска информацию: [TabletID](../concepts/glossary.md#tabletid), [поколение](../concepts/glossary.md#tablet-generation), [историю каналов](general-schema.md#history) и режим запуска ([лидер](../concepts/glossary.md#tablet-leader) или [подписчик](../concepts/glossary.md#tablet-follower)). Если таблетка не может стартовать или вынуждена прервать работу, то она уведомляет об этом Local, а тот передаёт информацию в Hive.
